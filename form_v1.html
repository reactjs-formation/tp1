<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Florent - TP1</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" />
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>

    <style>
      input[type=radio] {
        margin-right: 10px;
      }
      label{
        margin-bottom: 10px;
      }
    </style>

  </head>
  <body>
    <div id="root"></div>
    <!-- compilation JSX => JS -->
    <script type="text/babel">

    const questions = {
        'symfony' : {
            title : "Symfony design pattern.",
            question: 'Sélectionnez ci-dessous dans la liste la bonne définition caractérisant ce framework PHP',
            choices : ['MMV', 'MVC', 'MMVV'],
            response : 1,
            type : "select",
            name : "symfony",
            feedback : 'Symfony est basé sur le pattern MVC'
        },
        'react' : {
            title : "React est-il un framework ?",
            question: 'Répondez en choisissant une seule et bonne réponse ci-dessous',
            choices : ['yes', 'no'],
            response : 1,
            type : "radio",
            name : "react",
            feedback : "React est une librairie"
        },
        'jsx' : {
            title : "JSX c'est quoi ?",
            question: 'Répondez en choisissant une seule et bonne réponse ci-dessous',
            choices : ['JSX est un langage compilé', 'JSX est un sur-ensemble développé par Facebook'],
            response : 1,
            type: "radio" ,
            name : "jsx",
            feedback : 'JSX est un sur ensemble à JS'
        }
    }

    class App extends React.Component{
      constructor(props) {
        super(props)
        this.state = {
          showScore: false,
          showBtnScore: false,
          score: null
        }
      }

      updateAppState = (score) => {
        
        // montre le bouton d'affichage du score
        this.setState({
          showBtnScore: true,
          score: score
        }, () => {
          console.log('updateAppState', this.state)
        })
      }

      showScore = () => {
        this.setState({
          showScore: !this.state.showScore
        })
      }

      showBtnScore = (score) => {
        this.setState({
          showBtnScore: true,
          score: score
        })
      }
 
      render(){
        return(
          <div className="container">

            { this.state.showScore === false ?
              <div>
                <Form updateAppState={this.updateAppState} />
                {
                  this.state.showBtnScore === true  &&
                  <div className="text-center p-5">
                    <button className="btn btn-primary" onClick={this.showScore}>Montrer le score</button>
                  </div>
                }
              </div>
              :
              <div>
                Score {this.state.score}
              </div>
            }
          </div>
        )
      }
    }


    class Wrapper extends React.Component{
      render(){
        return(
          <div className="row flex-column">{this.props.children}</div>
        )
      }
    }

    class Form extends React.Component{

      
      constructor(props) {
        super(props)
        
        let q = Object.entries(questions)
        q = [
          q[1],
          q[2],
          q[0]
        ]
        const n = q.length
        
        this.state = {
          questions: q,
          currentAnswer: Array(n).fill(-1),
          finalAnswer: Array(n).fill(-1),
          score: 0,
          currentEmail: null,
          email: null,
          emailError: null
        }
      }

      hChange = (e) => {
        console.log('hChange', e.target, e.target.value, e.target.dataset.qIndex)
        const index = e.target.dataset.qIndex;
        this.state.currentAnswer[index] = e.target.value
        console.log(this.state.currentAnswer)
      }

      hClick = (e) => {
        e.preventDefault();
        console.log(e.target)
        const index = e.target.dataset.qIndex;
        this.state.finalAnswer[index] = this.state.currentAnswer[index]
        this.setState({}, () => {
          console.log(this.state)

          const n = this.state.questions.length
          // verifie si toute les reponses sont soumises
          let answersSubmited = true;
          for (let i = 0; i < n; i++) {
            const element = this.state.finalAnswer[i];
            if (element === -1) {
              console.log('element', element)
              answersSubmited = false;
              break;
            }
          }

          // calcule du score si les reponses sont toutes soumises
          if(answersSubmited) {
            let score = 0;
            console.log('Calcule du score', this.state)
            for (let i = 0; i < n; i++) {
              const answer = parseInt(this.state.finalAnswer[i]);
              const godAnswer = this.state.questions[0][1].response
              console.log('?', answer, godAnswer)
              if (answer === godAnswer) {
                score++;
              }
            }
            this.props.updateAppState(score);
          }
          
        })
      }

      emailRegistration = (e, save=false) => {
        e.preventDefault();

        let state = {}

        if(!save) {
          console.log('Update email')
          state = {
            currentEmail: e.target.value
          }
        } else {
          console.log('Save email')
          if(this.validateEmail(this.state.currentEmail)) 
            state = {
              email: this.state.currentEmail
            }
          else
            state = {
              emailError: 'email invalide'
            }
        }

        
        if (state !== {}) this.setState({...state}, () => {
          console.log(this.state.email)
        })
      }

      validateEmail(email) {
        return (email.match(/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/) !== null)
      }
        
      render(){
        
        return(
          <form className="w-50 m-auto">
            <Wrapper index={0} key={0}>
              <h1>QCM React</h1>
              <label htmlFor="test" className="form-check-label">votre email (*) : </label>
              <Input id="test" emailRegistration={this.emailRegistration} error={this.state.emailError} />
              <div className="form-group text-right col-12">
                <button className="btn btn-primary" type="submit" onClick={(e) => {this.emailRegistration(e, true)}} disabled={(this.state.email !== null)}>Valider</button>
              </div>
            </Wrapper>
            {
              this.state.questions.map((elm,i) => {

                // q pour question
                const q = elm[1];
                return (
                  <Wrapper key={i+1}>
                    {q.type === 'select' ? 
                      <Select {...q} num={i} hChange={this.hChange} />
                      :
                      q.type === 'radio' ? 
                        <Radio {...q} num={i} hChange={this.hChange} /> 
                        : 
                        <div></div>
                    }
                    
                    <div className="form-group text-right col-12">
                      <button type="submit" className="btn btn-primary" data-q-index={i} onClick={this.hClick} disabled={(this.state.finalAnswer[i] !== -1)}>Valider</button>
                    </div>
                  </Wrapper>
                )
              })
            }
            
          </form>
          
        )
      }
    }

    class Input extends React.Component{
        
      render(){
        return(
          <div className="form-group col-12">
            <input type="text" className="form-text" id={this.props.id} onChange={(e) => {this.props.emailRegistration(e, false)}} />
            {this.props.error && <div className="text-danger">{this.props.error}</div>}
          </div>
        )
      }
    }

    class Select extends React.Component{
        
      render(){
        return(
          <div className="form-text">
            <h2>
              {'Q'+(this.props.num+1)} {this.props.title}
            </h2>
            <div>
              <label htmlFor="" className="">{this.props.question}</label>
            </div>
            <select key={this.props.key} onChange={this.props.hChange} data-q-index={this.props.num} defaultValue="-1">
              <option value="-1">Choix</option>
              {
                this.props.choices.map((elm, i) => {
                  return (
                    <option key={i} value={i}>{elm}</option>
                  )
                })
              }
            </select>
          </div>
        )
      }
    }
    class Radio extends React.Component{
        
      render(){
        return(
          <div>
            <h2>{'Q'+(this.props.num+1)} {this.props.title}</h2>
            <div>
              <label htmlFor="" className="">{this.props.question}</label>
            </div>
            {
              this.props.choices.map((elm, i ) => {
                return (
                  <div key={i}>
                    <input type="radio" name={'q'+this.props.num} value={i} onChange={this.props.hChange} data-q-index={this.props.num} />
                    <label htmlFor=""> {elm}</label>
                  </div>
                )
              })
            }
          </div>
        )
      }
    }
    class File extends React.Component{
        
      render(){
        return(
          <div></div>
        )
      }
    }

    // Rendu dans le DOM
    ReactDOM.render(<App />,document.getElementById('root'));

    </script>
  </body>
</html>
